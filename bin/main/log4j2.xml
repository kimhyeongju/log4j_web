<?xml version="1.0" encoding="UTF-8"?>
<!--
âš ï¸ ì·¨ì•½í•œ Log4j2 ì„¤ì • íŒŒì¼ (êµìœ¡ ëª©ì ìš©)
ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”!
-->
<Configuration status="WARN">
    
    <!-- ë³€ìˆ˜ ì •ì˜ -->
    <Properties>
        <Property name="LOG_PATTERN">
            %d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n
        </Property>
        <Property name="LOG_PATTERN_WITH_LOCATION">
            %d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5level %logger{36}:%L - %msg%n
        </Property>
        <Property name="LOG_DIR">./logs</Property>
    </Properties>

    <Appenders>
        
        <!-- ì½˜ì†” ì¶œë ¥ -->
        <Console name="Console" target="SYSTEM_OUT">
            <PatternLayout pattern="${LOG_PATTERN}"/>
            <!-- ðŸš¨ ì·¨ì•½ì : ìƒ‰ìƒ ì½”ë“œ ì²˜ë¦¬ ì‹œ JNDI ë£©ì—… í™œì„±í™” -->
            <PatternLayout pattern="%highlight{${LOG_PATTERN}}{FATAL=red blink, ERROR=red, WARN=yellow bold, INFO=green, DEBUG=green bold, TRACE=blue}"/>
        </Console>

        <!-- ðŸš¨ ì·¨ì•½í•œ íŒŒì¼ ë¡œê±° - JNDI ë£©ì—… í™œì„±í™” -->
        <File name="VulnerableFileLogger" fileName="${LOG_DIR}/vulnerable.log">
            <PatternLayout pattern="${LOG_PATTERN}"/>
            <!-- ðŸš¨ JNDI ë£©ì—…ì´ í™œì„±í™”ëœ ìƒíƒœ (formatMsgNoLookups=false) -->
        </File>

        <!-- ë³´ì•ˆ ì´ë²¤íŠ¸ ë¡œê±° -->
        <File name="SecurityLogger" fileName="${LOG_DIR}/security.log">
            <PatternLayout pattern="%d{yyyy-MM-dd HH:mm:ss.SSS} [SECURITY] %-5level %logger{36} - %msg%n"/>
        </File>

        <!-- ì‚¬ìš©ìž í™œë™ ë¡œê±° -->
        <File name="UserActivityLogger" fileName="${LOG_DIR}/user-activity.log">
            <PatternLayout pattern="%d{yyyy-MM-dd HH:mm:ss.SSS} [ACTIVITY] %-5level %logger{36} - %msg%n"/>
        </File>

        <!-- ðŸš¨ ì·¨ì•½í•œ ë¡¤ë§ íŒŒì¼ ë¡œê±° -->
        <RollingFile name="VulnerableRollingFile" 
                     fileName="${LOG_DIR}/app.log"
                     filePattern="${LOG_DIR}/app-%d{yyyy-MM-dd}-%i.log.gz">
            <PatternLayout pattern="${LOG_PATTERN_WITH_LOCATION}"/>
            <Policies>
                <TimeBasedTriggeringPolicy />
                <SizeBasedTriggeringPolicy size="100 MB"/>
            </Policies>
            <DefaultRolloverStrategy max="10"/>
        </RollingFile>

        <!-- ì—ëŸ¬ ì „ìš© ë¡œê±° -->
        <File name="ErrorLogger" fileName="${LOG_DIR}/error.log">
            <PatternLayout pattern="%d{yyyy-MM-dd HH:mm:ss.SSS} [ERROR] %logger{36}:%L - %msg%n%throwable"/>
            <ThresholdFilter level="ERROR" onMatch="ACCEPT" onMismatch="DENY"/>
        </File>

        <!-- ðŸš¨ JNDI ê³µê²© íƒì§€ìš© ë¡œê±° (ì—­ì„¤ì ìœ¼ë¡œ ì·¨ì•½í•¨) -->
        <File name="JndiDetectionLogger" fileName="${LOG_DIR}/jndi-detection.log">
            <PatternLayout pattern="%d{yyyy-MM-dd HH:mm:ss.SSS} [JNDI-ALERT] - %msg%n"/>
        </File>

        <!-- ðŸš¨ ì·¨ì•½í•œ SMTP ë¡œê±° (ì„¤ì • ì˜ˆì‹œ) -->
        <!--
        <SMTP name="MailLogger" 
              subject="Log4j Vulnerability Alert: ${hostName}"
              to="admin@example.com"
              from="noreply@example.com"
              smtpHost="smtp.example.com"
              smtpPort="587"
              smtpUsername="user"
              smtpPassword="pass">
            <PatternLayout pattern="${LOG_PATTERN}"/>
            <ThresholdFilter level="ERROR" onMatch="ACCEPT" onMismatch="DENY"/>
        </SMTP>
        -->

    </Appenders>

    <Loggers>
        
        <!-- ðŸš¨ ì·¨ì•½ì  ì‹¤ìŠµ íŒ¨í‚¤ì§€ ë¡œê±° - ëª¨ë“  ìž…ë ¥ì„ ë¡œê¹… -->
        <Logger name="com.example.demo.api.vulnerability" level="DEBUG" additivity="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="VulnerableFileLogger"/>
            <AppenderRef ref="JndiDetectionLogger"/>
        </Logger>

        <!-- ðŸš¨ ì‚¬ìš©ìž ì„œë¹„ìŠ¤ ë¡œê±° - ì‚¬ìš©ìž ìž…ë ¥ ë¡œê¹… -->
        <Logger name="com.example.demo.api.common.service.UserService" level="DEBUG" additivity="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="UserActivityLogger"/>
            <AppenderRef ref="VulnerableRollingFile"/>
        </Logger>

        <!-- ðŸš¨ ê²Œì‹œíŒ ì„œë¹„ìŠ¤ ë¡œê±° - ê²€ìƒ‰ì–´ ë¡œê¹… -->
        <Logger name="com.example.demo.api.board.service.BoardService" level="DEBUG" additivity="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="VulnerableFileLogger"/>
            <AppenderRef ref="UserActivityLogger"/>
        </Logger>

        <!-- ë³´ì•ˆ ê´€ë ¨ ë¡œê±° -->
        <Logger name="SECURITY" level="INFO" additivity="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="SecurityLogger"/>
        </Logger>

        <!-- Spring Security ë¡œê±° -->
        <Logger name="org.springframework.security" level="DEBUG" additivity="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="SecurityLogger"/>
        </Logger>

        <!-- Hibernate SQL ë¡œê±° -->
        <Logger name="org.hibernate.SQL" level="DEBUG" additivity="false">
            <AppenderRef ref="Console"/>
        </Logger>

        <!-- ðŸš¨ HTTP ìš”ì²­ ë¡œê±° - í—¤ë” ì •ë³´ í¬í•¨ -->
        <Logger name="HTTP_REQUEST" level="DEBUG" additivity="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="VulnerableFileLogger"/>
        </Logger>

        <!-- ðŸš¨ ì—ëŸ¬ ë¡œê±° - ì‚¬ìš©ìž ìž…ë ¥ì´ í¬í•¨ëœ ì—ëŸ¬ -->
        <Logger name="ERROR_WITH_INPUT" level="ERROR" additivity="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="ErrorLogger"/>
            <AppenderRef ref="VulnerableFileLogger"/>
        </Logger>

        <!-- Root ë¡œê±° -->
        <Root level="INFO">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="VulnerableRollingFile"/>
            <AppenderRef ref="ErrorLogger" level="ERROR"/>
        </Root>

    </Loggers>

</Configuration>

<!--
âš ï¸ ë³´ì•ˆ ê²½ê³ :
ì´ ì„¤ì • íŒŒì¼ì€ Log4j ì·¨ì•½ì (CVE-2021-44228) ì‹¤ìŠµì„ ìœ„í•´ ì˜ë„ì ìœ¼ë¡œ ì·¨ì•½í•˜ê²Œ ìž‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

ì·¨ì•½í•œ ìš”ì†Œë“¤:
1. JNDI ë£©ì—…ì´ í™œì„±í™”ë¨ (formatMsgNoLookups ì„¤ì • ì—†ìŒ)
2. ì‚¬ìš©ìž ìž…ë ¥ì„ ì§ì ‘ ë¡œê¹…
3. HTTP í—¤ë” ì •ë³´ë¥¼ í•„í„°ë§ ì—†ì´ ë¡œê¹…
4. ì—ëŸ¬ ë©”ì‹œì§€ì— ì‚¬ìš©ìž ìž…ë ¥ í¬í•¨

ì™„í™” ë°©ë²•:
1. Log4j 2.17.1 ì´ìƒìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ
2. JVM ì˜µì…˜: -Dlog4j2.formatMsgNoLookups=true
3. ì‚¬ìš©ìž ìž…ë ¥ ê²€ì¦ ë° í•„í„°ë§
4. ë„¤íŠ¸ì›Œí¬ ìˆ˜ì¤€ì—ì„œ ì™¸ë¶€ LDAP/RMI ì—°ê²° ì°¨ë‹¨
-->