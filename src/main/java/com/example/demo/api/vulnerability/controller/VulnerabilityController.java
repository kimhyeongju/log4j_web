package com.example.demo.api.vulnerability.controller;

import com.example.demo.api.vulnerability.service.VulnerabilityService;
import lombok.RequiredArgsConstructor;
import lombok.extern.log4j.Log4j2;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import java.util.HashMap;
import java.util.Map;

/**
 * Log4j ì·¨ì•½ì  ì‹¤ìŠµ ì „ìš© ì»¨íŠ¸ë¡¤ëŸ¬
 * âš ï¸ êµìœ¡ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©! ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì‚¬ìš© ê¸ˆì§€
 */
@RestController
@RequestMapping("/api/vulnerable")
@RequiredArgsConstructor
@Log4j2
public class VulnerabilityController {

    private final VulnerabilityService vulnerabilityService;

    /**
     * ğŸš¨ ì§ì ‘ì ì¸ Log4j ì·¨ì•½ì  ì‹¤ìŠµ ì—”ë“œí¬ì¸íŠ¸
     * ì‚¬ìš©ì ì…ë ¥ì„ í•„í„°ë§ ì—†ì´ ë°”ë¡œ ë¡œê¹…
     */
    @PostMapping("/log-input")
    public ResponseEntity<?> logUserInput(@RequestParam String input, HttpServletRequest request) {
        // ğŸš¨ Log4j ì·¨ì•½ì : ì‚¬ìš©ì ì…ë ¥ì„ ê·¸ëŒ€ë¡œ ë¡œê¹…
        log.info("Received user input: {}", input);
        
        vulnerabilityService.logUserInput(input, request);
        
        return ResponseEntity.ok("Input logged: " + input);
    }

    /**
     * ğŸš¨ HTTP í—¤ë” ë¡œê¹… ì‹¤ìŠµ
     * User-Agentì— JNDI ë¬¸ìì—´ ì‚½ì… ê°€ëŠ¥
     */
    @GetMapping("/log-headers")
    public ResponseEntity<?> logHeaders(HttpServletRequest request) {
        // ğŸš¨ Log4j ì·¨ì•½ì : HTTP í—¤ë” ì§ì ‘ ë¡œê¹…
        log.info("Logging all HTTP headers for request from: {}", request.getRemoteAddr());
        
        vulnerabilityService.logHttpHeaders(request);
        
        return ResponseEntity.ok("Headers logged successfully");
    }

    /**
     * ğŸš¨ ì—ëŸ¬ ë¡œê¹… ì‹¤ìŠµ
     * ì—ëŸ¬ ë©”ì‹œì§€ì— ì‚¬ìš©ì ì…ë ¥ í¬í•¨
     */
    @PostMapping("/cause-error")
    public ResponseEntity<?> causeError(@RequestParam String errorInput, HttpServletRequest request) {
        try {
            // ì˜ë„ì ìœ¼ë¡œ ì—ëŸ¬ ë°œìƒ
            if (errorInput.contains("error")) {
                throw new RuntimeException("User triggered error with input: " + errorInput);
            }
            
            return ResponseEntity.ok("No error occurred");
        } catch (Exception e) {
            // ğŸš¨ Log4j ì·¨ì•½ì : ì—ëŸ¬ ë¡œê¹…ì— ì‚¬ìš©ì ì…ë ¥ í¬í•¨
            vulnerabilityService.logError(e.getMessage(), errorInput, request);
            return ResponseEntity.badRequest().body("Error occurred: " + e.getMessage());
        }
    }

    /**
     * ğŸš¨ ê²€ìƒ‰ íŒ¨í„´ ë¶„ì„ ì‹¤ìŠµ
     * ê²€ìƒ‰ì–´ì— íŠ¹ìˆ˜ ë¬¸ì ë° JNDI íŒ¨í„´ í¬í•¨ ê°€ëŠ¥
     */
    @GetMapping("/analyze-search")
    public ResponseEntity<?> analyzeSearchPattern(@RequestParam String searchTerm, HttpServletRequest request) {
        // ğŸš¨ Log4j ì·¨ì•½ì : ê²€ìƒ‰ íŒ¨í„´ ë¶„ì„ ì‹œ ë¡œê¹…
        log.info("Analyzing search pattern: {}", searchTerm);
        
        vulnerabilityService.analyzeSearchPattern(searchTerm, request);
        
        return ResponseEntity.ok("Search pattern analyzed: " + searchTerm);
    }

    /**
     * ğŸš¨ íŒŒì¼ ì—…ë¡œë“œ ì‹œë®¬ë ˆì´ì…˜
     * íŒŒì¼ëª…ê³¼ ë‚´ìš©ì— JNDI ë¬¸ìì—´ í¬í•¨ ê°€ëŠ¥
     */
    @PostMapping("/upload-file")
    public ResponseEntity<?> uploadFile(@RequestParam String fileName, 
                                       @RequestParam String fileContent,
                                       HttpServletRequest request) {
        // ğŸš¨ Log4j ì·¨ì•½ì : íŒŒì¼ ì •ë³´ ë¡œê¹…
        log.info("File upload - Name: {}, Size: {}", fileName, fileContent.length());
        
        vulnerabilityService.logFileUpload(fileName, fileContent, request);
        
        return ResponseEntity.ok("File processed: " + fileName);
    }

    /**
     * ğŸš¨ JNDI ê³µê²© íŒ¨í„´ ì‹œë®¬ë ˆì´ì…˜ (êµìœ¡ìš©)
     * ì‹¤ì œ ê³µê²© íŒ¨í„´ë“¤ì„ ë¡œê¹…í•˜ì—¬ ì·¨ì•½ì  ì‹œì—°
     */
    @PostMapping("/simulate-attack")
    public ResponseEntity<?> simulateJndiAttack(HttpServletRequest request) {
        // ğŸš¨ ì‹¤ì œ JNDI ê³µê²© íŒ¨í„´ë“¤ì„ ë¡œê¹…
        log.warn("Starting JNDI attack simulation from IP: {}", request.getRemoteAddr());
        
        vulnerabilityService.simulateJndiAttack();
        
        return ResponseEntity.ok("JNDI attack patterns simulated. Check logs for details.");
    }

    /**
     * ğŸš¨ ì‹¤ì‹œê°„ ê³µê²© íƒì§€ í…ŒìŠ¤íŠ¸
     */
    @PostMapping("/test-detection")
    public ResponseEntity<?> testAttackDetection(HttpServletRequest request) {
        // ğŸš¨ Log4j ì·¨ì•½ì : íƒì§€ í…ŒìŠ¤íŠ¸ ìš”ì²­ ë¡œê¹…
        log.info("Attack detection test requested from IP: {}, User-Agent: {}", 
                request.getRemoteAddr(), request.getHeader("User-Agent"));
        
        vulnerabilityService.detectRealTimeAttacks(request);
        
        return ResponseEntity.ok("Attack detection test completed");
    }

    /**
     * ğŸš¨ ì‚¬ìš©ì ì •ë³´ ë¡œê¹… ì‹¤ìŠµ
     */
    @PostMapping("/log-user-info")
    public ResponseEntity<?> logUserInfo(@RequestParam String username,
                                        @RequestParam String email,
                                        @RequestParam(required = false) String additionalInfo,
                                        HttpServletRequest request) {
        // ğŸš¨ Log4j ì·¨ì•½ì : ì‚¬ìš©ì ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ë¡œê¹…
        log.info("User info logging - Username: {}, Email: {}", username, email);
        
        vulnerabilityService.logUserInfo(username, email, additionalInfo, request);
        
        return ResponseEntity.ok("User information logged");
    }

    /**
     * ğŸš¨ ì„¤ì • ê°’ ì¡°íšŒ ë° ë¡œê¹…
     */
    @GetMapping("/config")
    public ResponseEntity<?> getConfigValue(@RequestParam String configKey,
                                           @RequestParam String configValue,
                                           HttpServletRequest request) {
        // ğŸš¨ Log4j ì·¨ì•½ì : ì„¤ì • ê°’ì„ ê·¸ëŒ€ë¡œ ë¡œê¹…
        log.info("Configuration access - Key: {}, Value: {}", configKey, configValue);
        
        vulnerabilityService.logConfigurationValue(configKey, configValue, request);
        
        return ResponseEntity.ok(Map.of("key", configKey, "value", configValue));
    }

    /**
     * ğŸš¨ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ë¡œê¹… ì‹œë®¬ë ˆì´ì…˜
     */
    @PostMapping("/log-query")
    public ResponseEntity<?> logDatabaseQuery(@RequestParam String query,
                                             @RequestParam String parameters,
                                             HttpServletRequest request) {
        // ğŸš¨ Log4j ì·¨ì•½ì : ì¿¼ë¦¬ì™€ íŒŒë¼ë¯¸í„°ë¥¼ ê·¸ëŒ€ë¡œ ë¡œê¹…
        log.info("Database query logging - Query: {}, Params: {}", query, parameters);
        
        vulnerabilityService.logDatabaseQuery(query, parameters, request);
        
        return ResponseEntity.ok("Database query logged");
    }

    /**
     * ğŸš¨ API ì‘ë‹µ ë¡œê¹…
     */
    @PostMapping("/log-response")
    public ResponseEntity<?> logApiResponse(@RequestParam String endpoint,
                                          @RequestParam String responseData,
                                          HttpServletRequest request) {
        // ğŸš¨ Log4j ì·¨ì•½ì : API ì‘ë‹µ ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ë¡œê¹…
        log.info("API response logging - Endpoint: {}, Data: {}", endpoint, responseData);
        
        vulnerabilityService.logApiResponse(endpoint, responseData, request);
        
        return ResponseEntity.ok("API response logged");
    }

    /**
     * ğŸš¨ ì„¸ì…˜ ì •ë³´ ë¡œê¹…
     */
    @PostMapping("/log-session")
    public ResponseEntity<?> logSessionInfo(@RequestParam String sessionId,
                                          @RequestParam String sessionData,
                                          HttpServletRequest request) {
        // ğŸš¨ Log4j ì·¨ì•½ì : ì„¸ì…˜ ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ë¡œê¹…
        log.info("Session logging - ID: {}, Data: {}", sessionId, sessionData);
        
        vulnerabilityService.logSessionInfo(sessionId, sessionData, request);
        
        return ResponseEntity.ok("Session information logged");
    }

    /**
     * ğŸš¨ ë©€í‹° íŒŒë¼ë¯¸í„° ë¡œê¹…
     */
    @PostMapping("/log-multiple")
    public ResponseEntity<?> logMultipleInputs(@RequestParam Map<String, String> params,
                                              HttpServletRequest request) {
        // ğŸš¨ Log4j ì·¨ì•½ì : ì—¬ëŸ¬ íŒŒë¼ë¯¸í„°ë¥¼ ë™ì‹œì— ë¡œê¹…
        params.forEach((key, value) -> log.info("Parameter - {}: {}", key, value));
        
        vulnerabilityService.logMultipleInputs(params, request);
        
        return ResponseEntity.ok("Multiple parameters logged: " + params.size() + " items");
    }

    /**
     * ğŸš¨ JSON í˜ì´ë¡œë“œ ë¡œê¹…
     */
    @PostMapping("/log-json")
    public ResponseEntity<?> logJsonPayload(@RequestBody Map<String, Object> payload,
                                           HttpServletRequest request) {
        // ğŸš¨ Log4j ì·¨ì•½ì : JSON í˜ì´ë¡œë“œë¥¼ ê·¸ëŒ€ë¡œ ë¡œê¹…
        log.info("JSON payload received: {}", payload);
        
        payload.forEach((key, value) -> {
            log.debug("JSON field - {}: {}", key, value);
        });
        
        return ResponseEntity.ok("JSON payload logged");
    }

    /**
     * ğŸš¨ ì¿ í‚¤ ì •ë³´ ë¡œê¹…
     */
    @GetMapping("/log-cookies")
    public ResponseEntity<?> logCookies(HttpServletRequest request) {
        // ğŸš¨ Log4j ì·¨ì•½ì : ì¿ í‚¤ ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ë¡œê¹…
        if (request.getCookies() != null) {
            for (javax.servlet.http.Cookie cookie : request.getCookies()) {
                log.info("Cookie - {}: {}", cookie.getName(), cookie.getValue());
            }
        }
        
        return ResponseEntity.ok("Cookies logged");
    }

    /**
     * ğŸš¨ URL íŒŒë¼ë¯¸í„° ë¡œê¹…
     */
    @GetMapping("/log-url-params")
    public ResponseEntity<?> logUrlParams(@RequestParam(required = false) String param1,
                                         @RequestParam(required = false) String param2,
                                         @RequestParam(required = false) String param3,
                                         HttpServletRequest request) {
        // ğŸš¨ Log4j ì·¨ì•½ì : URL íŒŒë¼ë¯¸í„°ë¥¼ ê°œë³„ì ìœ¼ë¡œ ë¡œê¹…
        if (param1 != null) log.info("URL param1: {}", param1);
        if (param2 != null) log.info("URL param2: {}", param2);
        if (param3 != null) log.info("URL param3: {}", param3);
        
        // ì „ì²´ ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ ë¡œê¹…
        String queryString = request.getQueryString();
        if (queryString != null) {
            log.info("Full query string: {}", queryString);
        }
        
        return ResponseEntity.ok("URL parameters logged");
    }

    /**
     * ğŸ” ê³µê²© íŒ¨í„´ ëª©ë¡ ì¡°íšŒ (êµìœ¡ìš©)
     */
    @GetMapping("/attack-patterns")
    public ResponseEntity<?> getAttackPatterns() {
        String[] patterns = vulnerabilityService.getCommonAttackPatterns();
        
        Map<String, Object> response = new HashMap<>();
        response.put("patterns", patterns);
        response.put("count", patterns.length);
        response.put("warning", "These are for educational purposes only!");
        
        return ResponseEntity.ok(response);
    }

    /**
     * ğŸš¨ í¼ ë°ì´í„° ë¡œê¹…
     */
    @PostMapping("/log-form")
    public ResponseEntity<?> logFormData(@RequestParam("username") String username,
                                        @RequestParam("password") String password,
                                        @RequestParam(value = "comment", required = false) String comment,
                                        HttpServletRequest request) {
        // ğŸš¨ Log4j ì·¨ì•½ì : í¼ ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ë¡œê¹…
        log.info("Form submission - Username: {}, Password: {}, Comment: {}", 
                username, password, comment);
        
        // ğŸš¨ ì¶”ê°€ì ì¸ ìƒì„¸ ë¡œê¹…
        log.debug("Form data from IP {}: user='{}', pass='{}', comment='{}'", 
                getClientIpAddress(request), username, password, comment);
        
        return ResponseEntity.ok("Form data logged");
    }

    /**
     * ğŸš¨ ì‹¤ì‹œê°„ ë¡œê·¸ ìŠ¤íŠ¸ë¦¬ë° ì‹œë®¬ë ˆì´ì…˜
     */
    @GetMapping("/stream-logs")
    public ResponseEntity<?> streamLogs(@RequestParam String data, HttpServletRequest request) {
        // ğŸš¨ Log4j ì·¨ì•½ì : ìŠ¤íŠ¸ë¦¬ë° ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¡œê¹…
        for (int i = 0; i < 5; i++) {
            log.info("Stream #{}: {}", i + 1, data);
            try {
                Thread.sleep(100); // 0.1ì´ˆ ê°„ê²©
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }
        
        return ResponseEntity.ok("Log streaming completed");
    }

    // ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œ
    private String getClientIpAddress(HttpServletRequest request) {
        String xForwardedFor = request.getHeader("X-Forwarded-For");
        if (xForwardedFor != null && !xForwardedFor.isEmpty()) {
            return xForwardedFor.split(",")[0].trim();
        }
        
        String xRealIp = request.getHeader("X-Real-IP");
        if (xRealIp != null && !xRealIp.isEmpty()) {
            return xRealIp;
        }
        
        return request.getRemoteAddr();
    }
}